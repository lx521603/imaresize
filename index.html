<!DOCTYPE html>
<html>
<head>
    <title>高效图片压缩</title>
    <!-- 换用更可靠的库 -->
    <script src="https://cdn.jsdelivr.net/npm/blueimp-load-image@5.16.0/js/load-image.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/javascript-loader@1.0.0/javascript-loader.min.js"></script>
</head>
<body>
    <input type="file" id="fileInput" accept="image/*">
    <button onclick="processImage()">处理图片</button>
    
    <script>
    async function processImage() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;
        
        // 使用更底层的 Canvas API
        const img = await loadImage(file);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // 设置目标尺寸
        const maxSize = 800;
        let width = img.width;
        let height = img.height;
        
        if (width > height && width > maxSize) {
            height = (height * maxSize) / width;
            width = maxSize;
        } else if (height > maxSize) {
            width = (width * maxSize) / height;
            height = maxSize;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        // 高质量绘制
        ctx.drawImage(img, 0, 0, width, height);
        
        // 多种压缩尝试
        let quality = 0.7;
        let compressedBlob;
        
        // 尝试不同的压缩方法
        for (let i = 0; i < 3; i++) {
            compressedBlob = await new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', quality);
            });
            
            console.log(`质量 ${quality}: ${(compressedBlob.size / 1024 / 1024).toFixed(2)}MB`);
            
            if (compressedBlob.size < 200 * 1024) break; // 小于200KB就停止
            quality -= 0.15;
        }
        
        // 下载结果
        const url = URL.createObjectURL(compressedBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'compressed.jpg';
        a.click();
        
        alert(`原图: ${(file.size/1024/1024).toFixed(2)}MB → 压缩后: ${(compressedBlob.size/1024/1024).toFixed(2)}MB`);
    }
    </script>
</body>
</html>