<!DOCTYPE html>
<html>
<head>
    <title>ä¼˜åŒ–ç‰ˆå›¾ç‰‡å‹ç¼©</title>
    <style>
        body { font-family: system-ui; padding: 20px; }
        .preset-buttons { margin: 10px 0; }
        .preset { padding: 8px 15px; margin: 5px; border: 1px solid #007cba; background: white; cursor: pointer; }
        .preset.active { background: #007cba; color: white; }
    </style>
</head>
<body>
    <h2>ğŸ¯ æ™ºèƒ½å›¾ç‰‡å‹ç¼©</h2>
    <input type="file" id="fileInput" accept="image/*">
    
    <div class="preset-buttons">
        <div>å¿«é€Ÿé¢„è®¾ï¼š</div>
        <button class="preset active" data-quality="0.8" data-width="1200">é«˜è´¨é‡ (80%)</button>
        <button class="preset" data-quality="0.65" data-width="1000">å¹³è¡¡ (65%)</button>
        <button class="preset" data-quality="0.5" data-width="800">å¼ºåŠ›å‹ç¼© (50%)</button>
    </div>
    
    <div>
        <label>è‡ªå®šä¹‰è´¨é‡: <span id="qualityValue">80</span>%</label>
        <input type="range" id="quality" min="40" max="90" value="80">
    </div>
    
    <div>
        <label>è‡ªå®šä¹‰å®½åº¦: <span id="widthValue">1200</span>px</label>
        <input type="range" id="width" min="600" max="2000" value="1200">
    </div>
    
    <button onclick="smartCompress()" style="padding: 10px 20px; background: #007cba; color: white; border: none;">
        å¼€å§‹å‹ç¼©
    </button>

    <script>
        let currentPreset = 'high';
        
        // é¢„è®¾æŒ‰é’®ç‚¹å‡»
        document.querySelectorAll('.preset').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.preset').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const quality = this.dataset.quality;
                const width = this.dataset.width;
                
                document.getElementById('quality').value = quality * 100;
                document.getElementById('width').value = width;
                document.getElementById('qualityValue').textContent = quality * 100;
                document.getElementById('widthValue').textContent = width;
            });
        });

        async function smartCompress() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert('è¯·é€‰æ‹©å›¾ç‰‡');
            
            const quality = parseInt(document.getElementById('quality').value) / 100;
            const maxWidth = parseInt(document.getElementById('width').value);
            
            console.log(`å¤„ç† ${(file.size/1024/1024).toFixed(2)}MB å›¾ç‰‡...`);
            
            const img = new Image();
            img.src = URL.createObjectURL(file);
            
            await new Promise(resolve => img.onload = resolve);
            
            // è®¡ç®—å°ºå¯¸ï¼ˆä¿æŒæ¯”ä¾‹ï¼‰
            let width = img.width;
            let height = img.height;
            if (width > maxWidth) {
                height = Math.round((height * maxWidth) / width);
                width = maxWidth;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // é«˜è´¨é‡æ¸²æŸ“
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, width, height);
            
            // æ™ºèƒ½å‹ç¼©ï¼šä»ç›®æ ‡è´¨é‡å¼€å§‹ï¼Œé€æ­¥è°ƒæ•´
            let targetSize = 250 * 1024; // ç›®æ ‡250KB
            let currentQuality = quality;
            let bestBlob = null;
            
            for (let i = 0; i < 4; i++) {
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/jpeg', currentQuality);
                });
                
                console.log(`è´¨é‡ ${currentQuality}: ${(blob.size/1024).toFixed(1)}KB`);
                
                if (!bestBlob || Math.abs(blob.size - targetSize) < Math.abs(bestBlob.size - targetSize)) {
                    bestBlob = blob;
                }
                
                // åŠ¨æ€è°ƒæ•´è´¨é‡
                if (blob.size > targetSize * 1.2) {
                    currentQuality -= 0.08; // æ–‡ä»¶å¤ªå¤§ï¼Œé™ä½è´¨é‡
                } else if (blob.size < targetSize * 0.8) {
                    currentQuality += 0.05; // æ–‡ä»¶å¤ªå°ï¼Œæé«˜è´¨é‡
                } else {
                    break; // æ¥è¿‘ç›®æ ‡ï¼Œåœæ­¢è°ƒæ•´
                }
                
                if (currentQuality < 0.4 || currentQuality > 0.9) break;
            }
            
            // ä¸‹è½½
            const url = URL.createObjectURL(bestBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compressed-${Math.round(bestBlob.size/1024)}kb.jpg`;
            a.click();
            
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            alert(`å‹ç¼©å®Œæˆ!\nåŸå›¾: ${(file.size/1024/1024).toFixed(2)}MB\nå‹ç¼©å: ${(bestBlob.size/1024).toFixed(1)}KB\nèŠ‚çœ: ${((1 - bestBlob.size/file.size) * 100).toFixed(1)}%`);
        }

        // å®æ—¶æ›´æ–°
        document.getElementById('quality').addEventListener('input', (e) => {
            document.getElementById('qualityValue').textContent = e.target.value;
        });
        document.getElementById('width').addEventListener('input', (e) => {
            document.getElementById('widthValue').textContent = e.target.value;
        });
    </script>
</body>
</html>